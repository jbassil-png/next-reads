<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Next Reads</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

  <h1>Next Reads</h1>
  <p>A personal dashboard for upcoming book releases.</p>

  <section>
    <h2>Add a book (Inbox)</h2>

    <form id="add-form">
      <div>
        <label>
          Title*:
          <input id="title" type="text" required>
        </label>
      </div>

      <div>
        <label>
          Author*:
          <input id="author" type="text" required>
        </label>
      </div>

      <div>
        <label>
          Release date* (YYYY-MM-DD):
          <input id="release_date" type="date" required>
        </label>
      </div>

      <div>
        <label>
          ISBN (optional):
          <input id="isbn" type="text" inputmode="numeric" placeholder="978...">
        </label>
      </div>

      <div>
        <label>
          Link (optional):
          <input id="link" type="url" placeholder="https://...">
        </label>
      </div>

      <button type="submit">Add to inbox</button>
    </form>

    <p>
      <button id="export-inbox">Export inbox JSON</button>
      <button id="clear-inbox">Clear inbox</button>
    </p>

    <pre id="export-output" style="white-space: pre-wrap;"></pre>
  </section>

  <hr>

  <div id="app"></div>

  <script>
    const INBOX_KEY = "next_reads_inbox_v1";

    function loadInbox() {
      const raw = localStorage.getItem(INBOX_KEY);
      if (!raw) return [];
      try { return JSON.parse(raw); } catch { return []; }
    }

    function saveInbox(inbox) {
      localStorage.setItem(INBOX_KEY, JSON.stringify(inbox));
    }

    async function loadBooks() {
      const response = await fetch("books.json");
      const data = await response.json();
      return data.books;
    }

    function daysBetweenUTC(a, b) {
      const msPerDay = 24 * 60 * 60 * 1000;
      const aUTC = Date.UTC(a.getUTCFullYear(), a.getUTCMonth(), a.getUTCDate());
      const bUTC = Date.UTC(b.getUTCFullYear(), b.getUTCMonth(), b.getUTCDate());
      return Math.round((bUTC - aUTC) / msPerDay);
    }

    function parseISODate(dateStr) {
      const [y, m, d] = dateStr.split("-").map(Number);
      return new Date(Date.UTC(y, m - 1, d));
    }

    function renderTable(rows, mode) {
      const table = document.createElement("table");
      table.border = "1";
      table.cellPadding = "6";
      table.cellSpacing = "0";

      table.innerHTML = `
        <thead>
          <tr>
            <th>Title</th>
            <th>Author</th>
            <th>Release date</th>
            <th>Days</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector("tbody");
      const today = new Date();

      for (const book of rows) {
        const release = parseISODate(book.release_date);
        const delta = daysBetweenUTC(today, release);

        const daysLabel =
          mode === "upcoming"
            ? `in ${delta}d`
            : `+${Math.abs(delta)}d`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${book.title}</td>
          <td>${book.author}</td>
          <td>${book.release_date}</td>
          <td>${daysLabel}</td>
          <td>${book.status}</td>
        `;
        tbody.appendChild(tr);
      }

      return table;
    }

    function renderSection(title, rows, mode) {
      const section = document.createElement("section");
      section.style.marginTop = "18px";

      const h2 = document.createElement("h2");
      h2.textContent = `${title} (${rows.length})`;

      section.appendChild(h2);

      if (rows.length === 0) {
        const p = document.createElement("p");
        p.textContent = "None.";
        section.appendChild(p);
        return section;
      }

      section.appendChild(renderTable(rows, mode));
      return section;
    }

    function renderInbox(inbox) {
      const out = document.getElementById("export-output");
      out.textContent = "";

      // Simple inline view: list titles
      if (inbox.length === 0) {
        out.textContent = "Inbox is empty.";
        return;
      }

      out.textContent = inbox.map((b, i) => `${i + 1}. ${b.title} â€” ${b.author} (${b.release_date})`).join("\n");
    }

    async function copyToClipboard(text) {
      await navigator.clipboard.writeText(text);
    }

    (async function init() {
      // Inbox wiring
      let inbox = loadInbox();
      renderInbox(inbox);

      const form = document.getElementById("add-form");
      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const title = document.getElementById("title").value.trim();
        const author = document.getElementById("author").value.trim();
        const release_date = document.getElementById("release_date").value;
        const isbn = document.getElementById("isbn").value.trim();
        const link = document.getElementById("link").value.trim();

        const item = {
          title,
          author,
          release_date,
          status: "upcoming",
          ...(isbn ? { isbn } : {}),
          ...(link ? { link } : {})
        };

        inbox = [item, ...inbox];
        saveInbox(inbox);
        renderInbox(inbox);
        form.reset();
      });

      document.getElementById("export-inbox").addEventListener("click", async () => {
        const payload = JSON.stringify(inbox, null, 2);
        const out = document.getElementById("export-output");
        out.textContent = payload;

        try {
          await copyToClipboard(payload);
          alert("Inbox JSON copied to clipboard.");
        } catch {
          alert("Could not copy to clipboard. JSON is shown on the page.");
        }
      });

      document.getElementById("clear-inbox").addEventListener("click",
