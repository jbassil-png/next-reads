<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Next Reads</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; max-width: 1050px; }
    h1 { margin: 0 0 6px; }
    p { margin: 0 0 18px; color: #444; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; }
    .card h2 { margin: 0 0 10px; font-size: 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end; }
    label { display: grid; gap: 6px; font-size: 13px; color: #333; }
    input { padding: 9px 10px; border-radius: 10px; border: 1px solid #ccc; }
    button { padding: 9px 12px; border-radius: 10px; border: 1px solid #ccc; background: #f7f7f7; cursor: pointer; }
    button.primary { background: #111; color: #fff; border-color: #111; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .muted { color: #666; font-size: 13px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; text-align: left; padding: 8px 6px; font-size: 14px; vertical-align: top; }
    th { color: #555; font-weight: 600; }
    .results { display: grid; gap: 10px; }
    .result { border: 1px solid #eee; border-radius: 10px; padding: 10px; display: grid; gap: 6px; }
    .result-title { font-weight: 650; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    textarea { width: 100%; min-height: 180px; padding: 10px; border-radius: 10px; border: 1px solid #ccc;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    hr { border: none; border-top: 1px solid #eee; margin: 12px 0; }
  </style>
</head>
<body>

  <h1>Next Reads</h1>
  <p>A personal dashboard for upcoming book releases. Add by title+author → validate → add.</p>

  <div class="grid">
    <section class="card">
      <h2>Add a book</h2>

      <form id="validate-form" class="row">
        <label>
          Title
          <input id="title" type="text" required>
        </label>

        <label>
          Author
          <input id="author" type="text" required>
        </label>

        <button id="validate-btn" type="submit" class="primary">Validate</button>
      </form>

      <div id="selected" class="muted" style="margin-top:10px;"></div>

      <div class="actions">
        <button id="add-btn" type="button" class="primary" disabled>Add to list</button>
        <button id="clear-selection" type="button">Clear selection</button>
      </div>

      <hr>

      <div class="muted">
        Validation uses Google Books. If only a year/month is available, we store a sortable date and a precision flag.
      </div>

      <div id="results" class="results" style="margin-top:12px;"></div>
    </section>

    <section class="card">
      <h2>Dashboard</h2>
      <div id="app" class="muted">Loading…</div>
    </section>

    <section class="card">
      <h2>Save changes to GitHub</h2>
      <div class="muted">
        This app can’t directly edit <code>books.json</code> yet, so new books are saved in your browser as a “Draft”.
        When ready, generate an updated <code>books.json</code>, paste it into GitHub, and commit.
      </div>

      <div class="actions">
        <button id="generate-json" type="button">Generate updated books.json</button>
        <button id="copy-json" type="button">Copy output</button>
        <button id="clear-draft" type="button">Clear local Draft</button>
      </div>

      <textarea id="output" placeholder="Click “Generate updated books.json”…"></textarea>
    </section>
  </div>

  <script>
    const DRAFT_KEY = "next_reads_draft_v1";

    function loadDraft() {
      const raw = localStorage.getItem(DRAFT_KEY);
      if (!raw) return [];
      try { return JSON.parse(raw); } catch { return []; }
    }

    function saveDraft(draft) {
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    }

    async function loadBooksJson() {
      const response = await fetch("books.json", { cache: "no-store" });
      return await response.json();
    }

    // Date precision handling (agreed defaults):
    // YYYY      -> YYYY-12-31, precision "year"
    // YYYY-MM   -> YYYY-MM-01, precision "month"
    // YYYY-MM-DD-> exact, precision "day"
    function normalizePublishedDate(publishedDate) {
      if (!publishedDate || typeof publishedDate !== "string") return null;

      if (/^\d{4}$/.test(publishedDate)) {
        return { release_date: `${publishedDate}-12-31`, precision: "year", raw: publishedDate };
      }
      if (/^\d{4}-\d{2}$/.test(publishedDate)) {
        return { release_date: `${publishedDate}-01`, precision: "month", raw: publishedDate };
      }
      if (/^\d{4}-\d{2}-\d{2}$/.test(publishedDate)) {
        return { release_date: publishedDate, precision: "day", raw: publishedDate };
      }
      return null;
    }

    function parseISODate(dateStr) {
      const [y, m, d] = dateStr.split("-").map(Number);
      return new Date(Date.UTC(y, m - 1, d));
    }

    function daysBetweenUTC(a, b) {
      const msPerDay = 24 * 60 * 60 * 1000;
      const aUTC = Date.UTC(a.getUTCFullYear(), a.getUTCMonth(), a.getUTCDate());
      const bUTC = Date.UTC(b.getUTCFullYear(), b.getUTCMonth(), b.getUTCDate());
      return Math.round((bUTC - aUTC) / msPerDay);
    }

    function pickIsbn13(industryIdentifiers) {
      if (!Array.isArray(industryIdentifiers)) return null;
      const isbn13 = industryIdentifiers.find(x => x && x.type === "ISBN_13" && x.identifier);
      return isbn13 ? isbn13.identifier : null;
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderDashboard(books) {
      const app = document.getElementById("app");
      const today = new Date();

      const upcoming = [];
      const waiting = [];

      for (const b of books) {
        const release = parseISODate(b.release_date);
        const delta = daysBetweenUTC(today, release);
        if (delta >= 0) upcoming.push(b);
        else waiting.push(b);
      }

      upcoming.sort((a, b) => a.release_date.localeCompare(b.release_date));
      waiting.sort((a, b) => b.release_date.localeCompare(a.release_date));

      function sectionHtml(title, rows, mode) {
        if (!rows.length) {
          return `<div style="margin-top:10px;">
            <h3 style="margin:10px 0 8px; font-size:14px;">${title} (0)</h3>
            <div class="muted">None.</div>
          </div>`;
        }

        const rowsHtml = rows.map(book => {
          const release = parseISODate(book.release_date);
          const delta = daysBetweenUTC(today, release);
          const daysLabel = mode === "upcoming" ? `in ${delta}d` : `+${Math.abs(delta)}d`;
          const precision = book.release_date_precision ? ` (${book.release_date_precision})` : "";
          const source = book.source ? ` · ${escapeHtml(book.source)}` : "";

          return `
            <tr>
              <td>${escapeHtml(book.title)}</td>
              <td>${escapeHtml(book.author)}</td>
              <td>${escapeHtml(book.release_date)}${precision}</td>
              <td>${daysLabel}</td>
              <td>${escapeHtml(book.status || "upcoming")}${source}</td>
            </tr>
          `;
        }).join("");

        return `<div style="margin-top:10px;">
          <h3 style="margin:10px 0 8px; font-size:14px;">${title} (${rows.length})</h3>
          <table>
            <thead>
              <tr><th>Title</th><th>Author</th><th>Release</th><th>Days</th><th>Status</th></tr>
            </thead>
            <tbody>${rowsHtml}</tbody>
          </table>
        </div>`;
      }

      app.innerHTML =
        sectionHtml("Upcoming", upcoming, "upcoming") +
        sectionHtml("Released (waiting for library)", waiting, "waiting");
    }

    async function searchGoogleBooks(title, author) {
      const q = `intitle:${title} inauthor:${author}`;
      const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent
